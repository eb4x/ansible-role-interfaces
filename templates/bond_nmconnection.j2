# {{ ansible_managed }}

[connection]
id={{ item.device }}
type=bond
interface-name={{ item.device }}
{% if item.zone is defined %}
zone={{ item.zone }}
{% endif %}

{% for bridge in interfaces_bridge_interfaces %}
{%   if item.device in bridge.ports %}
master={{ bridge.device }}
slave-type=bridge
{%   endif %}
{% endfor %}

{% if item.mtu is defined %}
[ethernet]
mtu={{ item.mtu }}
{% endif %}

[bond]
{% if item.bond_ad_select is defined %}
ad_select={{ item.bond_ad_select }}
{% endif %}
{% if item.bond_downdelay is defined %}
downdelay={{ item.bond_downdelay }}
{% endif %}
{% if item.bond_lacp_rate is defined %}
lacp_rate={{ item.bond_lacp_rate }}
{% endif %}
miimon={{ item.bond_miimon | default(100) }}
{% if item.bond_mode is defined %}
mode={{ item.bond_mode }}
{% endif %}
{% if item.bond_updelay is defined %}
updelay={{ item.bond_updelay }}
{% endif %}
{% if item.bond_xmit_hash_policy is defined %}
xmit_hash_policy={{ item.bond_xmit_hash_policy }}
{% endif %}

[ipv4]
{% if item.bootproto == 'dhcp' %}
method=auto
{% elif item.bootproto == 'static' and item.address is defined and item.address | length %}
method=manual
{%   if item.netmask is defined %}
address1={{ (item.address ~'/'~ item.netmask) | ipaddr('host/prefix') }}
{%   endif %}
{%   if item.gateway is defined and item.gateway | length %}
gateway={{ item.gateway }}
{%   endif %}
{% else %}
method=disabled
{% endif %}
{% for route in item.route | default([]) %}
{%   if 'gateway' in route %}
route{{ loop.index }}={{ (route.network ~'/'~ route.netmask) | ipaddr('network/prefix') }},{{ route.gateway }}
{%   endif %}
{#   TODO: dev, table, options #}
{% endfor %}
{% if item.dnsnameservers is defined %}
dns={{ item.dnsnameservers | join(',') }}
{% endif %}

[ipv6]
{% if item.ip6 is defined %}
method={{ (item.bootproto == 'static') | ternary('manual', 'auto') }}
{%   if item.ip6.address is defined and item.ip6.netmask is defined %}
address1={{ (item.ip6.address ~'/'~ item.ip6.netmask) | ipaddr('host/prefix') }}
{%   endif %}
{%   if item.ip6.gateway is defined %}
gateway={{ item.ip6.gateway }}
{%   endif %}
{%   for route in item.ip6.route | default([]) %}
{%     if 'gateway' in route %}
route{{ loop.index }}={{ (route.network ~'/'~ route.netmask) | ipaddr('network/prefix') }},{{ route.gateway }}
{%     endif %}
{#     TODO: dev, table, options #}
{%   endfor %}
{% else %}
method=disabled
{% endif %}
